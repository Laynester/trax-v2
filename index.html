<!DOCTYPE html>
<html lang="en" class="h-full w-full bg-transparent">

<head>
	<meta charset="UTF-8" />
	<title>Trax v2</title>

	<!-- Alpine.js (defer is important) -->
	<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<link href="cdn.jsdelivr.net" rel="stylesheet" />
	<script src="https://cdn.tailwindcss.com"></script>
	<style type="text/tailwindcss">
		:root {
        --stone-800: theme(colors.stone.800);
		--cyan-600: theme(colors.cyan.600);
        --cyan-700: theme(colors.cyan.700);
		--cyan-800: theme(colors.cyan.800);
        --cyan-950: theme(colors.cyan.950);
        --stone-500: theme(colors.stone.500);
      }
    </style>
	<style>
		.shadow-cyan {
			box-shadow: inset 0 0 2px 2px var(--stone-800), 2px 2px var(--cyan-700),
				-2px -2px var(--cyan-950);
		}

		.shadow-cyan-inset {
			box-shadow: inset 3px 3px 2px var(--cyan-950);
		}

		.shadow-stone-inset {
			box-shadow: inset 2px 2px 2px var(--stone-800);
		}

		.shadow-cyan-outset {
			box-shadow: inset 0 0 0 2px var(--cyan-600), inset 0 0 0 3px var(--cyan-800);
		}

		* {
			user-select: none;
			image-rendering: pixelated;
		}
	</style>

	<style type="text/tailwindcss">
		html {
        font-size: 14px;
      }
    </style>
</head>

<body class="bg-transparent h-full w-full flex flex-col overflow-hidden">
	<div x-data="traxMachine()"
		class="w-full flex-1 overflow-hidden flex flex-col gap-2 bg-cyan-900 rounded rounded-xl lg:rounded-none p-1 border border-black ring-1 ring-inset ring-cyan-700 overflow-hidden">
		<div class="flex gap-2 h-[40%] shrink-0 px-2 pt-3 w-full">
			<div class="flex flex-col w-[20%] min-w-[210px] pb-[10px]">
				<div
					class="text-xs bg-stone-700 h-full p-1 overflow-hidden shrink-0 rounded rounded-xl border-black border shadow-cyan">
					<div class="flex flex-col h-full overflow-y-scroll">
						<template x-for="group in groups" :key="group[0]">
							<div class="flex flex-col gap-2 items-center p-2 border border-transparent border-dashed rounded hover:border-white/25"
								:class="`${selectedGroup == group ? 'bg-stone-800' : '' }`"
								@click="selectedGroup = group">
								<div class="text-white w-full" x-text="`${group[0]}`"></div>
								<template x-if="selectedGroup == group">
									<div class="flex flex-wrap">
										<template
											x-for="collection in collections.filter(val=> (selectedGroup[1].includes(parseInt(val[0]))))"
											:key="collection[0]">
											<div class="flex items-center p-2 hover:bg-white hover:bg-opacity-25 rounded cursor-pointer relative text-white text-center"
												:class="selectedCollections.find(c => c[0] === collection[0]) ? 'bg-green-600' : ''"
												@click="selectCollection(collection)">
												<img :src="`./imgs/${collection[2]}`" />
											</div>
										</template>
									</div>
								</template>
							</div>
						</template>
					</div>
				</div>
			</div>
			<div class="flex flex-col gap-2 h-full w-full overflow-hidden">
				<div class="flex gap-2 overflow-hidden h-full overflow-x-hidden">
					<div
						class="gap-2 w-full grid grid-cols-4 lg:grid-cols-5 overflow-y-auto overflow-x-hidden items-start">
						<template x-for="collection, index in selectedCollections" :key="collection[0]">
							<div class="flex flex-col w-full my-auto" x-data="{hoverMe: false}"
								:class="{'brightness-75': hoverMe}">
								<div class="flex items-center font-bold bg-neutral-500 rounded-t-xl flex-1 gap-1 border-black border ring-inset ring-1 ring-neutral-400 py-2 px-3 justify-center w-full text-white text-center relative"
									@click="selectCollection(collection)" @mouseenter="hoverMe = true"
									@mouseleave="hoverMe = false">
									<span x-text="collection[1]" class="text-xs text-center truncate"></span>
								</div>
								<div
									class="grid grid-cols-3 grid-rows-3 gap-2 p-2 w-full h-full bg-cyan-800 border border-black border-t-0 ring-1 ring-inset ring-cyan-700 rounded-b-xl">
									<template x-for="sample, ind in getSamples(collection)" :key="sample[0]">
										<div class="flex rounded items-center justify-center ring-1 ring-inset border-black border relative cursor-grab aspect-square"
											:class="colors[index] + '-500 hover:' + colors[index] + '-600' + ' ring-' + colors[index].slice(3) + '-400'"
											@mouseenter="previewSample(sample)" @mouseleave="stopPreview()"
											@click="selectSample(sample, ind)">
											<div
												class="bg-black/25 absolute top-[50%] mt-50 left-0 end-0 bottom-0 pointer-events-none">
											</div>
											<img :src="`./imgs/tracks/${ind + 1}.png`"
												class="z-10 pointer-events-none" />
										</div>
									</template>
								</div>
							</div>
						</template>
						<template x-for="i in 5 - selectedCollections.length" :key="i">
							<div class="flex flex-col w-full brightness-75 my-auto">
								<div
									class="flex items-center font-bold bg-cyan-900 rounded-t-xl flex-1 gap-1 border-black border shadow-cyan-inset py-2 px-1 justify-center w-full text-white text-center relative">
									<span class="text-xs text-center truncate opacity-0">
										hi u fags
									</span>
								</div>
								<div
									class="grid grid-cols-3 grid-rows-3 gap-2 p-2 w-full h-full bg-cyan-800 border border-black border-t-0 ring-1 ring-inset ring-cyan-700 rounded-b-xl">
									<template x-for="ind in 9" key="ind">
										<div
											class="flex rounded items-center justify-center shadow-cyan-inset bg-cyan-900 border-black border relative cursor-grab p-1 aspect-square">
										</div>
									</template>
								</div>
							</div>
						</template>
					</div>
				</div>
				<div class="flex gap-1">
					<div :class="`${getSongDurationSeconds() == 0 ? 'hidden' : 'hidden lg:flex'}`"
						class="w-1/4 rounded border border-black text-white items-center text-opacity-25 bg-cyan-900 ring-1 ring-inset ring-cyan-700 hover:brightness-[1.5]"
						@click="copyTraxString()">
						<div class="px-1 truncate" x-text="traxString"></div>
					</div>
					<template x-if="selectedSample">
						<button
							class="px-4 py-2 rounded text-white border border-black ring-1 ring-inset text-xs flex gap-4 justify-between items-center"
							@click="selectedIndex = 0; selectedSample = null"
							:class="`${sampleColor(selectedSample)}-500 hover:${sampleColor(selectedSample)}-600 ring-${sampleColor(selectedSample, false)}-300`">
							<div class="w-full flex-1">Deselect</div>
							<img :src="`./imgs/tracks/${selectedIndex + 1}.png`" class="mx-auto" />
						</button>
					</template>
					<div class="ms-auto flex gap-1 w-full">
						<button :class="`${getSongDurationSeconds() == 0 ? 'hidden' : ''}`"
							class="ms-auto bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex w-[40px] items-center justify-center"
							@click="isPlaying ? pauseSong() : playSong()">
							<img :src="`./imgs/${!isPlaying ? 'play' : 'pause'}.png`" />
						</button>
						<button :class="`${getSongDurationSeconds() == 0 ? 'hidden' : ''}`"
							class="bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex w-[40px] items-center justify-center"
							@click="stopSong()">
							<img :src="`./imgs/stop.png`" />
						</button>
						<button :class="`${getSongDurationSeconds() == 0 ? 'hidden' : ''}`"
							class="bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex w-[40px] items-center justify-center"
							@click="saveSong()">
							<img :src="`./imgs/save.png`" />
						</button>
						<button :class="`${(getSongDurationSeconds() == 0 || !config.download) ? 'hidden' : ''}`"
							class="bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex w-[40px] items-center justify-center"
							@click="exportAndDownload()">
							<img :src="`./imgs/${isDownloading ? 'progress_bubbles.gif' : 'download.png'}`" />
						</button>
						<button :class="`${getSongDurationSeconds() > 0 ? 'hidden' : ''}`"
							class="bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex items-center justify-center w-full"
							@click="importString()">
							Import song?
						</button>
						<button :class="`${(getSongDurationSeconds() == 0 || !config.lowpass) ? 'hidden' : ''}`"
							class="bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex w-[40px] items-center justify-center"
							@click="toggleMasterFilter">
							<img :src="`./imgs/lowpass-${isFiltered ? 'on' : 'off'}.png`" />
						</button>
						<button :class="`${(getSongDurationSeconds() == 0) ? 'hidden' : ''}`"
							class="bg-cyan-900 hover:bg-cyan-800 px-4 py-2 rounded text-white border border-black ring-1 ring-inset ring-cyan-700 flex w-[40px] items-center justify-center"
							@click="clearSong()">
							<img src="./imgs/trash.png" />
						</button>
						<div class="flex gap-0" :class="`${getSongDurationSeconds() == 0 ? 'hidden' : ''}`">
							<button
								class="p-2 rounded-s text-white border border-black ring-1 ring-inset bg-cyan-900 hover:bg-cyan-800 text-xs ring-cyan-700"
								@click="decreaseOffset()">
								<img src="./imgs/pager-left.png" />
							</button>
							<button
								class="p-2 rounded-e text-white border border-black ring-1 ring-inset bg-cyan-900 hover:bg-cyan-800 text-xs ring-cyan-700"
								@click="increaseOffset()">
								<img src="./imgs/pager-right.png" />
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="h-[60%] flex flex-col mt-[-10px]">
			<div
				class="rounded rounded-xl bg-cyan-900 border border-black h-full p-2 relative ring-1 ring-inset ring-cyan-700 overflow-hidden">
				<div class="flex flex-col gap-2 h-full relative overflow-hidden w-full">
					<div class="flex gap-2 w-full overflow-y-auto overflow-x-hidden relative">
						<template x-if="tracks.length > 0 && config.volume">
							<div
								class="flex flex-col gap-2 relative shrink-0 w-[60px] pb-[23px] pt-[23px] bg-cyan-900  z-30">
								<template x-for="track in tracks" :key="track.id">
									<div
										class="border border-white/25 border-dashed h-full flex items-center justify-center p-1 text-white rounded h-[40px] w-full relative shrink-0">
										<input type="text"
											class="border-0 focus:ring-0 focus:shadow-none bg-transparent w-full text-center"
											placeholder="0" x-model.number="track.volume"
											@input="track.gain.gain.value = track.volume / 100">
									</div>
								</template>
							</div>
						</template>
						<div class="w-full flex flex-col gap-2 relative h-full pb-[23px] pt-[23px] " x-ref="timeline">
							<template x-for="track in tracks" :key="track.id + '-a'">
								<div class="relative h-[40px] shadow-stone-inset bg-stone-700 rounded p-1 shrink-0 w-full border border-black overflow-x-hidden"
									@mouseenter="hoveredTrackId = track.id"
									@mouseleave="hoveredTrackId = null; hoverX = null"
									@mousemove="hoverX = Math.max(0, snapToGrid($event))"
									@click="insertClipAt(track, hoverX)">
									<template x-if="hoveredTrackId === track.id && selectedSample">
										<div class="rounded absolute top-[3px] bottom-[3px] shrink-0 flex items-center justify-center gap-4 border border-black z-10 opacity-50"
											:style="`left:${displayX(hoverX) + 3}px; width:${selectedSample ? Math.round(selectedSample[2] * grid.pxPerBeat) : 0}px`"
											:class="`${sampleColor(selectedSample)}-500 hover:${sampleColor(selectedSample)}-600`">
											<div class="bg-black/25 absolute top-[50%] mt-50 left-0 end-0 bottom-0">
											</div>
										</div>
									</template>
									<template x-for="clip in track.clips.filter(c => c)" :key="clip.id">
										<div class="rounded absolute top-[3px] bottom-[3px] shrink-0 flex items-center justify-center gap-4 border border-black ring-1 ring-inset z-10"
											:style="`left: ${displayX(clip.x) + 3}px;width:${clip.width}px`"
											:class="sampleColor(clip.sample) + '-500 hover:' + sampleColor(clip.sample) + '-600' + ' ring-' + sampleColor(clip.sample, false) + '-300' + (isPlaying ? ' brightness-[0.6] saturate-[1.2]' : '')"
											@click="deleteClip(track, clip)"
											@contextmenu.prevent="deleteClip(track, clip)">
											<div class="bg-black/25 absolute top-[50%] mt-50 left-0 end-0 bottom-0">
											</div>
											<template x-for="i in Math.round(clip.width / grid.pxPerBeat)">
												<div class="z-10">
													<img :src="`./imgs/tracks/${sampleIndex(clip)}.png`"
														class="mx-auto" />
												</div>
											</template>
										</div>
									</template>
								</div>
							</template>
						</div>
						<template x-if="tracks.length > 0">
							<div class="absolute top-0 bottom-0 z-20 border border-cyan-950 rounded flex flex-col pointer-events-none"
								:class="{'ms-[68px]': config.volume}"
								:style="{ left:displayX(playheadX) + 'px', height: 39 + (47 * tracks.length) + 'px'  }"
								x-data="{ moving: false }" @mouseup.window="moving = false" @mousemove.window="
    if (moving) {
        const snapped = snapToGrid($event)
        const maxX = (Math.round(($refs.timeline.clientWidth + offset) / grid.pxPerBeat) - 2) * grid.pxPerBeat
        playheadX = Math.min(Math.max(offset, snapped), maxX)
    }
">
								<div class="w-full h-[20px] flex justify-center items-center p-[2px] gap-[5px] border-2 border-cyan-600 hover:bg-cyan-400 shrink-0 ring-inset ring-1 ring-cyan-950 rounded-t bg-cyan-500 cursor-pointer pointer-events-auto"
									@mousedown.prevent="moving = true">
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
								</div>
								<div class="w-[49px] border-2 h-full border-cyan-600 ring-inset ring-1 ring-cyan-950 border-t-0 border-b-0
									pointer-events-none" :class="{'backdrop-brightness-[1.7]': isPlaying}">
								</div>
								<div class="w-full h-[20px] flex justify-center items-center p-[2px] gap-[5px] border-2 border-cyan-600 hover:bg-cyan-400 shrink-0 ring-inset ring-1 ring-cyan-950 rounded-b bg-cyan-500 cursor-pointer pointer-events-auto"
									@mousedown.prevent="moving = true">
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
									<div class="bg-cyan-900 w-[1px] h-full"></div>
								</div>
							</div>
						</template>

					</div>
					<div class="w-full rounded border border-dashed border-white border-opacity-25 p-2 text-white text-opacity-25 text-center hover:bg-green-700/25"
						@click="createTrack()">
						Add Track
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="./data.js?1"></script>
	<script src="./app.js?1"></script>
	<script>
		// window.onload = () => {
		// window.postMessage({
		// 	type: "load-trax-string",
		// 	//string: '1:0,4;455,18;0,5;443,2;447,2;443,4;447,2;443,4;447,2;443,4;447,2;443,2;448,4;455,6:2:0,1;430,2;0,7;406,2;0,2;406,2;0,2;406,2;0,2;414,4;0,1;455,2;0,2;261,2;455,2;0,2;261,2;455,2;0,2;261,2;455,2;0,8;412,2;0,2;430,2;261,2:3:0,4;427,20;0,1;458,28;0,2;257,6:4:0,6;426,18;0,1;453,4;451,2;453,4;451,2;453,4;451,2;255,4;451,4;0,2;446,2;0,2;255,2:5:0,6;432,2;0,2;432,2;0,2;432,2;0,2;432,2;0,2;432,3;0,3;442,1;444,2;0,3;442,1;444,2;0,3;442,1;444,2;0,3;442,1;444,2;0,8;458,4;0,2;432,1:6-50:0,2;455,2;0,51;255,2;0,4;432,2:7-25:455,2;0,51;432,1;0,5;255,2:8-50:0,2;427,2:9-50:0,4;426,2:10-25:',
		// 	//string: '1-50:411,6;0,22;517,2;0,19;84,1:2-75:0,2;443,2;0,21;87,4;0,19;84,1:3:0,4;443,22;0,2;505,12;506,4;508,4;443,8;513,1;522,2:4:0,6;83,22;0,2;517,14;519,2;517,2;0,2;83,6;0,1;518,1:5:0,9;84,1;89,2;84,2;89,2;84,2;89,2;84,2;89,2;0,8;521,8;520,4;0,2;513,1;84,1;0,4;519,2;87,4;518,2:6:0,10;442,2;0,2;442,2;0,2;442,2;0,2;442,1;0,3;518,3;0,4;518,1;509,2;0,1;518,1;509,2:7-25:0,29;518,1;0,20;84,1--lowpass',
		// });
		// };
	</script>
</body>

</html>